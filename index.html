<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>상업경제 기출 DB</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", "Cantarell", sans-serif;
        background-color: #ffffff;
        color: #374151;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
      }

      .header {
        padding: 64px 0 48px 0;
        text-align: center;
        border-bottom: 1px solid #e5e7eb;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 8px;
        letter-spacing: -0.025em;
      }

      .csv-links {
        padding: 48px 0;
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .csv-links a {
        display: inline-flex;
        align-items: center;
        padding: 12px 20px;
        background-color: #ffffff;
        color: #374151;
        text-decoration: none;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.15s ease;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }

      .csv-links a:hover {
        background-color: #f9fafb;
        border-color: #9ca3af;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .content {
        padding: 48px 0;
        padding-top: 0;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      th,
      td {
        border: none;
        padding: 16px 20px;
        text-align: left;
        border-bottom: 1px solid #f3f4f6;
      }

      th {
        background-color: #f9fafb;
        color: #374151;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover {
        background-color: #f9fafb;
      }

      .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
        padding: 16px 20px;
        border-radius: 8px;
        text-align: center;
        margin: 24px 0;
        font-size: 0.875rem;
      }

      .info-message {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
        padding: 16px 20px;
        border-radius: 8px;
        text-align: center;
        margin: 24px 0;
        font-size: 0.875rem;
      }

      .chapters-overview {
        margin-top: 48px;
      }

      .chapter-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        transition: all 0.15s ease;
      }

      .chapter-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }

        .header {
          padding: 48px 0 32px 0;
        }

        .header h1 {
          font-size: 2rem;
        }

        .csv-links {
          padding: 32px 0;
          gap: 12px;
        }

        .csv-links a {
          padding: 10px 16px;
          font-size: 0.8rem;
        }

        .content {
          padding: 32px 0;
        }

        th,
        td {
          padding: 12px 16px;
          font-size: 0.875rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <a
          style="text-decoration: none; color: inherit"
          href="/sangup_classification"
          ><h1>상업경제 기출 DB</h1></a
        >
      </div>

      <div class="csv-links">
        <a href="?csv=1.csv">Chapter 01</a>
        <a href="?csv=2.csv">Chapter 02</a>
        <a href="?csv=3.csv">Chapter 03</a>
        <a href="?csv=4.csv">Chapter 04</a>
      </div>

      <div class="content">
        <div id="csv-table"></div>

        <div id="statistics" style="margin-top: 48px">
          <h2
            style="
              margin-bottom: 24px;
              color: #111827;
              font-size: 1.5rem;
              font-weight: 600;
            "
          >
            통계 정보
          </h2>
          <div id="stats-content"></div>
        </div>
      </div>
    </div>

    <script>
      function parseCsvRow(rowString) {
        const cells = [];
        let currentPos = 0;

        // First column (unquoted)
        const firstComma = rowString.indexOf(",");
        if (firstComma === -1) {
          return [rowString];
        }
        cells.push(rowString.substring(0, firstComma));
        currentPos = firstComma + 1;

        // Other columns (quoted)
        while (currentPos < rowString.length) {
          if (rowString[currentPos] === '"') {
            let endQuote = -1;
            let searchPos = currentPos + 1;
            while (endQuote === -1) {
              const nextQuote = rowString.indexOf('"', searchPos);
              if (nextQuote === -1) {
                // Malformed, no closing quote
                endQuote = rowString.length;
              } else if (rowString[nextQuote + 1] === '"') {
                // Escaped quote
                searchPos = nextQuote + 2;
              } else {
                endQuote = nextQuote;
              }
            }
            cells.push(
              rowString.substring(currentPos + 1, endQuote).replace(/""/g, '"')
            );
            currentPos = endQuote + 2; // Move past quote and comma
          } else {
            // Fallback for unquoted values, though not expected in this format
            const nextComma = rowString.indexOf(",", currentPos);
            if (nextComma === -1) {
              cells.push(rowString.substring(currentPos));
              currentPos = rowString.length;
            } else {
              cells.push(rowString.substring(currentPos, nextComma));
              currentPos = nextComma + 1;
            }
          }
        }
        return cells;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const csvFile = urlParams.get("csv");

        if (csvFile) {
          fetch(csvFile)
            .then((response) => response.text())
            .then((data) => {
              const table = document.createElement("table");
              const rows = data.trim().split("\n");

              const thead = document.createElement("thead");
              const headerRow = document.createElement("tr");
              const headers = rows[0].split(",");
              headers.forEach((headerText) => {
                const th = document.createElement("th");
                th.textContent = headerText.replace(/"/g, "");
                headerRow.appendChild(th);
              });
              thead.appendChild(headerRow);
              table.appendChild(thead);

              const tbody = document.createElement("tbody");
              for (let i = 1; i < rows.length; i++) {
                if (!rows[i]) continue;
                const row = document.createElement("tr");
                const cells = parseCsvRow(rows[i]);
                cells.forEach((cellText) => {
                  const td = document.createElement("td");
                  td.textContent = cellText;
                  row.appendChild(td);
                });
                tbody.appendChild(row);
              }
              table.appendChild(tbody);

              const container = document.getElementById("csv-table");
              container.innerHTML = "";
              container.appendChild(table);
            })
            .catch((error) => {
              console.error("Error fetching CSV file:", error);
              document.getElementById(
                "csv-table"
              ).innerHTML = `<div class="error-message">Error loading ${csvFile}. Please make sure the file exists and is in the same directory as this HTML file.</div>`;
            });
        } else {
          document.getElementById("csv-table").innerHTML =
            '<div class="info-message">볼 CSV 파일을 지정하세요. 예를 들어 URL에 "?csv=1.csv"를 추가합니다.</div>';

          loadStatistics();
        }
      });

      function loadStatistics() {
        fetch("all.csv")
          .then((response) => response.text())
          .then((data) => {
            const stats = analyzeData(data);
            displayStatistics(stats);
          })
          .catch((error) => {
            console.error("Error loading statistics:", error);
            document.getElementById("stats-content").innerHTML =
              '<div class="error-message">통계 정보를 불러올 수 없습니다.</div>';
          });
      }

      function analyzeData(csvData) {
        const rows = csvData.trim().split("\n");
        const headers = rows[0].split(",");
        const data = rows.slice(1).map((row) => {
          const cells = parseCsvRow(row);
          return {
            chapter: cells[0]?.replace(/"/g, ""),
            theme: cells[1]?.replace(/"/g, ""),
            problemNumber: cells[2]?.replace(/"/g, ""),
            reason: cells[3]?.replace(/"/g, ""),
          };
        });

        const chapterStats = {};
        const themeStats = {};
        const yearStats = {};
        const totalProblems = data.length;

        data.forEach((item) => {
          if (item.chapter && item.theme) {
            const chapter = item.chapter.trim();
            const theme = item.theme.trim();

            chapterStats[chapter] = (chapterStats[chapter] || 0) + 1;
            themeStats[theme] = (themeStats[theme] || 0) + 1;

            const combinedTheme = `${chapter} - ${theme}`;
            themeStats[combinedTheme] = (themeStats[combinedTheme] || 0) + 1;

            if (item.problemNumber) {
              const year = item.problemNumber.split(".")[0];
              if (year && year.length === 4) {
                yearStats[year] = (yearStats[year] || 0) + 1;
              }
            }
          }
        });

        return {
          totalProblems,
          chapterStats,
          themeStats,
          yearStats,
        };
      }

      function displayStatistics(stats) {
        const statsContent = document.getElementById("stats-content");

        let html = `
              <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 32px;">
                  <div class="stat-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
                      <h3 style="color: #374151; font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;">총 문제 수</h3>
                      <div style="font-size: 2rem; font-weight: 700; color: #1f2937;">${
                        stats.totalProblems
                      }문제</div>
                  </div>
                  
                  <div class="stat-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
                      <h3 style="color: #374151; font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;">챕터 수</h3>
                      <div style="font-size: 2rem; font-weight: 700; color: #1f2937;">${
                        Object.keys(stats.chapterStats).length
                      }개</div>
                  </div>
                  
                  <div class="stat-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
                      <h3 style="color: #374151; font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;">테마 수</h3>
                      <div style="font-size: 2rem; font-weight: 700; color: #1f2937;">${
                        Object.keys(stats.themeStats).length
                      }개</div>
                  </div>
              </div>
          `;

        html += `
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 32px;">
                  <div class="stat-section">
                      <h3 style="color: #374151; font-size: 1.25rem; font-weight: 600; margin-bottom: 16px;">챕터별 문제 수</h3>
                      <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
          `;

        Object.entries(stats.chapterStats)
          .sort((a, b) => b[1] - a[1])
          .forEach(([chapter, count]) => {
            const percentage = ((count / stats.totalProblems) * 100).toFixed(1);
            html += `
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f3f4f6;">
                          <span style="color: #374151; font-weight: 500;">${chapter}</span>
                          <div style="display: flex; align-items: center; gap: 12px;">
                              <span style="color: #6b7280; font-size: 0.875rem;">${percentage}%</span>
                              <span style="color: #1f2937; font-weight: 600;">${count}문제</span>
                          </div>
                      </div>
                  `;
          });

        html += `
                      </div>
                  </div>
                  
                  <div class="stat-section">
                      <h3 style="color: #374151; font-size: 1.25rem; font-weight: 600; margin-bottom: 16px;">연도별 문제 수</h3>
                      <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
          `;

        Object.entries(stats.yearStats)
          .sort((a, b) => b[0] - a[0])
          .forEach(([year, count]) => {
            const percentage = ((count / stats.totalProblems) * 100).toFixed(1);
            html += `
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f3f4f6;">
                          <span style="color: #374151; font-weight: 500;">${year}년</span>
                          <div style="display: flex; align-items: center; gap: 12px;">
                              <span style="color: #6b7280; font-size: 0.875rem;">${percentage}%</span>
                              <span style="color: #1f2937; font-weight: 600;">${count}문제</span>
                          </div>
                      </div>
                  `;
          });

        html += `
                      </div>
                  </div>
              </div>
          `;

        const chapterThemeStats = {};
        Object.entries(stats.themeStats).forEach(([theme, count]) => {
          console.log("Theme:", theme, "Count:", count);
          const chapterMatch = theme.match(/Chapter (\d+):/);
          if (chapterMatch) {
            const chapterNum = chapterMatch[1];
            if (!chapterThemeStats[chapterNum]) {
              chapterThemeStats[chapterNum] = [];
            }
            chapterThemeStats[chapterNum].push({ theme, count });
          }
        });

        console.log("Chapter Theme Stats:", chapterThemeStats);

        html += `
            <div style="margin-top: 32px;">
                <h3 style="color: #374151; font-size: 1.25rem; font-weight: 600; margin-bottom: 16px;">테마별 문제 수</h3>
        `;

        if (Object.keys(chapterThemeStats).length === 0) {
          html += `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; text-align: center;">
              <p style="color: #6b7280;">테마 데이터를 찾을 수 없습니다. 테마 형식을 확인해주세요.</p>
            </div>
          `;
        } else {
          Object.keys(chapterThemeStats)
            .sort((a, b) => parseInt(a) - parseInt(b))
            .forEach((chapterNum) => {
              const themes = chapterThemeStats[chapterNum];
              const chapterTotal = themes.reduce(
                (sum, item) => sum + item.count,
                0
              );
              const chapterPercentage = (
                (chapterTotal / stats.totalProblems) *
                100
              ).toFixed(1);

              html += `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; margin-bottom: 16px;">
                        <div style="background: #f9fafb; padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #374151; font-weight: 600; font-size: 1.1rem;">Chapter ${chapterNum}</span>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="color: #6b7280; font-size: 0.875rem;">${chapterPercentage}%</span>
                                    <span style="color: #1f2937; font-weight: 600;">${chapterTotal}문제</span>
                                </div>
                            </div>
                        </div>
                `;

              themes
                .sort((a, b) => {
                  const themeAMatch = a.theme.match(/Theme (\d+)/);
                  const themeBMatch = b.theme.match(/Theme (\d+)/);
                  if (themeAMatch && themeBMatch) {
                    return parseInt(themeAMatch[1]) - parseInt(themeBMatch[1]);
                  }
                  return a.theme.localeCompare(b.theme);
                })
                .forEach(({ theme, count }) => {
                  const percentage = (
                    (count / stats.totalProblems) *
                    100
                  ).toFixed(1);
                  const themeMatch = theme.match(/Theme (\d+):\s*(.+)/);
                  if (themeMatch) {
                    const themeNum = themeMatch[1];
                    const themeName = themeMatch[2];
                    html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f3f4f6;">
                                    <span style="color: #374151; font-weight: 500; padding-left: 16px;">Theme ${themeNum}: ${themeName}</span>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="color: #6b7280; font-size: 0.875rem;">${percentage}%</span>
                                        <span style="color: #1f2937; font-weight: 600;">${count}문제</span>
                                    </div>
                                </div>
                            `;
                  } else {
                    html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f3f4f6;">
                                    <span style="color: #374151; font-weight: 500; padding-left: 16px;">${theme}</span>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="color: #6b7280; font-size: 0.875rem;">${percentage}%</span>
                                        <span style="color: #1f2937; font-weight: 600;">${count}문제</span>
                                    </div>
                                </div>
                            `;
                  }
                });

              html += `</div>`;
            });
        }

        html += `</div>`;

        statsContent.innerHTML = html;
      }
    </script>
  </body>
  <footer style="text-align: center; padding: 20px; font-size: 12px">
    Copyright ⓒ 2025 sid12g All rights reserved.
  </footer>
</html>
